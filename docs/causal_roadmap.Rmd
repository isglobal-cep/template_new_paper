---
title: "Causal Roadmap"
author: Lorenzo Fabbri
output:
  bookdown::pdf_document2:
    number_sections: false
  html_document: default
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
```

```{r, echo=FALSE}
# Type of adjustment set from DAG
type.mas <- "minimal"
# Type of effect to be estimated from DAG
type.effect <- "direct"
```


\textcolor{red}{Most of the following was **copy-pasted** from published papers. Some of the Sections must be filled depending on the chosen causal framework.}


<!-- ####################################################################### -->
# Step 0: Formulate the research question(s)
<!-- ####################################################################### -->

The **aim** of the present study was to research the...

The study **population** was based on..., consisting of $\text{N}=$... Inclusion criteria were:...

Measured **exposures** consisted of...

The **primary outcome** was... **Secondary outcomes** included...

<!-- ####################################################################### -->
## Descriptive analyses
<!-- ####################################################################### -->

<!-- ####################################################################### -->
# Step 1: Define a realistic statistical model
<!-- ####################################################################### -->

For time index $t$, let $W_t$ denote the set of potential confounders, $A_t$ the observed exposures, 
and $Y_t$ the clinical outcome of interest. For each subject $i$ and each time index $t$, 
we assumed its observed data $O_{ti} = (W_{ti}, A_{ti}, Y_{ti})$ were generated by sampling from a distribution 
$\mathbb{P}_{0,t}$ compatible with the causal model specified in \@ref(eq:npsem).

<!-- ####################################################################### -->
# Step 2: Specify a causal model and causal quantity of interest
<!-- ####################################################################### -->

We specified the following nonparametric structural equation model (NPSEM) to present the data generating process, 
including its measured confounders $W_t$, exposures $A_t$, and outcome $Y_t$, for each time index $t$:

\begin{equation}
\begin{aligned}
  W_t &= f_{W{_t}} (U_{W_{t}}) \\
  A_t &= f_{A_{t}} (W_t, U_{A_{t}}) \\
  Y_t &= f_{Y_{t}} (W_t, A_t, U_{Y_{t}}), 
\end{aligned}
(\#eq:npsem)
\end{equation}

where $(f_{W{_t}}, f_{A_{t}}, f_{Y_{t}})$ were the nonparametric structural equations, 
and $(U_{W_{t}}, U_{A_{t}}, U_{Y_{t}})$ were the unmeasured factors contributing the confounders, exposures, and outcome, respectively. 
The corresponding causal graph (without indexes for ease of notation) is given in Figure \@ref(fig:causal-graph).

```{r causal-graph, echo=FALSE, fig.cap="Causal graph corresponding to structural equations.", fig.height=3, fig.width=3}
causal.graph <- ggdag::dagify(A ~ W + U_A, Y ~ W + A + U_Y, W ~ U_W, 
                              exposure = "A", outcome = "Y") %>%
  ggdag::tidy_dagitty()
ggdag::ggdag(causal.graph) + ggdag::theme_dag()
```

For each time index, we specified our causal parameter $\phi$ as...

As **primary analysis**, we estimated....

As **secondary analyses**, we estimated...

In the following sections, we present the simplified DAG specific to each research question.

## Research question 1:...

```{r echo=FALSE, fig.cap="Simplified DAG for research question 1."}
sdag1 <- ggdag::dagify(X_ti ~ W_t, 
                       Y ~ W_t + X_ti, 
                       exposure = "X_ti", outcome = "Y") %>%
  ggdag::tidy_dagitty() %>%
  ggdag::ggdag(text_size = 2, node_size = 10) + ggdag::theme_dag() +
  ggplot2::ggtitle("RQ1")
```

```{r, echo=FALSE}
ggpubr::ggarrange(sdag1, ..., 
                  ncol = x, nrow = y)
```

<!-- ####################################################################### -->
# Step 3: Identification and the statistical estimand
<!-- ####################################################################### -->

For the causal parameter $\phi$, which involves a summary measure of the distribution of counterfactuals, 
to be identified in terms of the observed data distribution, several assumptions would be required:

* **No unmeasured confounding**: There are no unmeasured common causes of the exposure and the subsequent outcome. In our context, this assumption would be violated if, for example, an unmeasured variable influenced both the exposure levels and the outcome. We cannot guarantee that this assumption holds, and therefore limit our interpretations to statistical associations rather than causal effects.
* **Positivity**:....
* **Independence** of subjects. This assumption also implies **no interference**: the exposure level $a$ for a given subject does not affect the outcomes of the other subjects.
* **Consistency**: If $A = a$ for any subject, then $Y(a) = Y$. This means that the counterfactual outcome for a subject with its observed exposure level is the observed outcome.
* **Time-ordering**: The confounders $W$ precede the exposure $A$, which also precedes the outcome $Y$.

If these identifiability assumptions held, we could specify and focus our estimation efforts on a statistical estimand that equals the wished-for causal effect. In the (likely) case that they are not satisfied, we could still specify and focus our estimation efforts on a statistical estimand that is as close as possible to the causal parameter. Factoring the joint distribution of the observed data $\mathbb{P}_0$ into $\mathbb{P}_0 (O) = \mathbb{P}_0(Y|A,W) \mathbb{P}_0(A|W) \mathbb{P}_0(W)$, it can be shown that the statistical estimand corresponding to expected counterfactual outcome..., is given by

$$
..., 
$$

Therefore, our statistical estimand of interest was

$$
....
$$

<!-- ####################################################################### -->
# Step 4: Estimation from data and statistical inference
<!-- ####################################################################### -->

<!-- ####################################################################### -->
# Step 5: Interpretation and sensitivity analyses to inform a substantive conclusion
<!-- ####################################################################### -->

Highlight possible **limitations**:

* When considering only one exposure, we do not consider the effect of the others on that exposure and the outcome;
* When we consider only one outcome, we do not consider the effect of the other outcomes on that one;
* Although the interpretation of $\psi^{\text{causal}}$ is clear, how closely $\psi^{\text{stat}}$ matches it merits discussion. One considers the plausibility of each of the identifying assumptions in turn.

We performed **sensitivity analysis** to measure robustness to unmeasured confounders, based on the following considerations:

* Broadly, an open question is whether the estimated treatment effect is biased due to confounding by unmeasured covariates. We can examine how the substantive conclusion would be impacted under a range of presumed causal bias, $\delta = \psi^{\text{causal}} - \psi^{\text{stat}}$. That is, how *strong* would a particular confounder (or group of confounders) have to be in order to change the conclusions of this study? In a worst case scenario, how vulnerable are the study's results to many or all unobserved confounders acting **together**, possibly non-linearly? The exercise illustrates how the effect estimates, and confidence interval bounds change, depending on the magnitude and direction of the hypothesized gap;
* We implemented the following methods to conduct sensitivity analysis:
  * Selection bias and stratification...
  * Placebo treatment (replacement of the actual treatment with a random variable);
  * We performed leave-1-out analyses to assess the influence of single subjects on the effect of interest.

We took into consideration the following points to *validate* our results:

* We evaluated whether the obtained results are of any relevance from a public health point of view.

<!-- ####################################################################### -->
# Appendix
<!-- ####################################################################### -->

## Checklist A: Reproducibility

Table with random seed, names, description, and version numbers of all software packages.

| **Name** | **Version** | **Description** |
|:---------|:------------|:----------------|
| Random seed | NA | Will be set to $X$ |
| `R` | `r I(paste0(R.version$major, ".", R.version$minor))` | Statistical programming environment |
| ... | ... | ... |

## Checklist B1: `xxx` package specifications

Table providing values for all non-data arguments, and brief rationale when departing from the default specification.

| **Argument** | **Setting** | **Default** (Y/N) | **Comment** |
|:-------------|:------------|:------------------|:------------|
| ... | ... | ... | ... |

## DAGs

```{r, echo=FALSE}
source("../DAGs/dag_v1.R")
source("../code/dags.R")

dags <- dag.v1()
```

### Research question 1:...

```{r, echo=FALSE, fig.cap="DAG for Research question 1.", fig.height=10, fig.width=18}
dag.rq1 <- dags$rq1 %>%
  dagitty::dagitty()
dag.rq1 %>% ggdag::tidy_dagitty() %>%
  ggdag::ggdag_status(text_size = 10, text_col = "black") +
  ggdag::theme_dag() + ggdag::scale_adjusted() +
  ggplot2::theme(legend.text = ggplot2::element_text(size = 20))
```

The `r I(type.mas)` sufficient adjustment sets for estimating the `r I(type.effect)` effect of X on Y are:

```{r, echo=FALSE}
dagitty::adjustmentSets(x = dag.rq1, 
                        type = type.mas, effect = type.effect)
```

\newpage

<!-- ####################################################################### -->
# Bibliography
<!-- ####################################################################### -->

